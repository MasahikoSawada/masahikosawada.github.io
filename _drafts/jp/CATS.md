---
layout: post
title: CATS
tags:
  - Database
  - Lock
---

# CATS
* MySQL 8.0.3で採用されたロックスケジュール
* 同時実行数が32以上のときに使用される
* これまでのMySQLに比べてレイテンシが300倍減り、スループットが6.5倍向上した

# Challenges
1. An online problem
   * 全てのトランザクションの完了時間はわからない。XX秒まてば必ずロックを取得できる、というわけではない
2. Dependencies
   * トランザクションが同時に同じオブジェクトに対してロックを要求するとトランザクション間に依存性が発生する。DBMSでは、その依存性が複数のオブジェクトにまたがって発生するので複雑
3. Non-unifoem access patterns
   * 全てのトランザクションがオブジェクトをロックする順序や個数はバラバラ
4. Multiple lockng methods
   * 共有、排他の複数のロックレベルがある

以前のMySQLやPostgreSQLではロックスケジュールとしてFIFOが使用されていた。

# ロックスケジュールとは？
ある複数のトランザクションが同じオブジェクト（他の誰かに既にロックされている）に対してロック取得待ちをしている。そのオブジェクトが開放された時、「どのトランザクションが次にロックを取得するべきか」、という問題。より優先度の高いトランザクションに対してロックを与える。この優先度をどのように決めるかを議論している。

ロックスケジュールがFIFOの場合は、「一番始めに待っていたトランザクション」が次にロックを取得する。

# 既存手法
## Most Lock First (MLF)
より多くトランザクションをブロックしているトランザクションに高い優先度を与える。
欠点は、より多くのロックを取得しているが、そのロックに依存する（そのロックを待っている）トランザクションが少ない時に、効果を発揮しないこと。
例えば、よく参照される行が1つあって多くのトランザクションがその行のロックをほしいとする。その行1つのみをロックしているトランザクションAと、あまり人気のない行をロックしているトランザクションBの優先度は、A<Bとなる。トランザクションAに先にロックを与えればトランザクションAの処理が完了後、より多くのトランザクションが実行できる。

## Most Blocking Locks First (MBLF)
より多くのトランザクションをブロックしているトランザクションに高い優先度を与える。
欠点は、全てのブロックされているトランザクションを等価に扱う、という点。
一つのオブジェクトに対して3つのトランザクションが待っている場合と、3つのオブジェクトに対して3つのトランザクションが待っている場合では、ブロックしているトランザクション数は同じ3つだが、後者の方が圧倒的に効率が良い。

## Deepest Dependency Fist (DDF)
より依存関係が深い（長い）トランザクションに高い優先度を与える。
より長い依存関係は、より多いトランザクションをシーケンスにブロックしているという経験則に基づいている。

欠点はMBLFと似ている。1つのオブジェクトに対して1つのトランザクションが待っている場合* 3と、1つのオブジェクトに3つのトランザクションが待っている場合では、後者の方がロック解放後に同時に実行できる。

## Horiozontal ContentionとVertical Contention
他のトランザクションによって直接日宇町とされる多くのオブジェクトに対するロックを保持している場合をHorizontal Contentionという。MLFとMBLFはこっち。

一方、依存関係のつながりに注目するした場合をVertical Contentionという。DDFはこっち。

# Largest-Dependency-Set-First(LDSF)
ここからが本題。

特徴は、
* ブロックしているトランザクションの総数が多いトランザクションに高い優先度を与える
* 共有ロックを与える時は、共有ロックを要求しているトランザクション**全て**に与える。
* 排他ロックを要求するトランザクション(Tx1とする)がロックを取得できるタイミングは、「（ある時点での共有ロックを要求するトランザクション数）＞（Tx1がブロックするトランザクション数)」となった時。


(共有ロックを要求するトランザクション数) > (排他ロックを要求するトランザクションがブロックしているトランザクション数)の時は、ロックの要求タイミングに関係なく共有ロックを要求するトランザクション全てのロックを与えて、それ以外にときにのみ排他ロックを要求するトランザクションへロックを与える。

# bLDSF



つまり、共有ロックを


## V






