---
layout: post
title: FDWとデッドロック
tags:
  - Deadlocks
  - Foreign Data Wrapper
---

11/22に開催された[PostgreSQL Conference Japan 2018]()のLTで発表したネタの続き＆詳細です。

# TR;DL
* FDW環境での分散デッドロック対策は自動的に検知されない
* 対策するにはlock_timeoutを使おう

# 何を発表したのか？

スライドは[こちら]()をご参照ください。ざっくりまとめると、

* デッドロックが好き
  * デッドロックの検知方法はさまざまあるが、pg_blocking_pids()と再帰SQLを組み合わせると簡単に出来る
* FDWを使った分散トランザクションでは、分散デッドロックの検知機能がない
* lock_timeoutを使ってデッドロックを防ぐ方法が現実的

という感じです。

ちなみに、FDW環境での分散デッドロックは、一つのトランザクションで２つ以上の外部サーバを触ることで簡単に発生する可能性があります。例えば、以下のような感じです。


```

```

# FDW環境での分散デッドロックの検知
PostgreSQLをベースとした（または利用している）分散データベースでは、分散デッドロック検知をするものと、しないものがあります。例えば、PostgreSQLのEXTENSIONとして提供されていてそれを使うとシャーディンで出来るという[Citus]()では、Coordinatorノードが定期的にWorkerノードのWFG(Wait For Graph)を取得し、[グローバルなWFGを作成することで分散デッドロック検知]()をしています(LTで紹介した内容と同じです)。一方、Postgres-XLでは[分散デッドロック検知の機能はなく]()、各サーバ(CoordinatorノードやDataノード)ローカルでのデッドロック検知機能のみをサポートしています。

普段からFDWで遊んでいることもあり、postgres_fdwやoracle_fdwを使ったPostgreSQLの[FDWシャーディング]()でも分散デッドロック検知ができたらいいなと思い、方法を考えました。方法はずっと前から考えていて、結果も何となく出ていたのですが、カンファレンスの前日にふいにLTで話そうかなと思い立ち、無事発表させていただきました。（ **LT** でデッドロック検知を話すのはややライトではなかったようですが。）

# 分散デッドロックを検知する
FDW環境での分散デッドロックを検知するために検討した方法は **グローバルなWFG** を作り、それを用いてデッドロックを検知することです。この方法は[path-pushingとも呼ばれており]()、PostgreSQLにすでにWFGからデッドロックを検知する方法がありますし、LTで話したとおりSQLでも簡単に検出できるので、実装しやすい方法の一つだと思います(Citusでやっている方法と同じです）。

この方法では、ざっくり以下の手順で処理をすることになります。

1. 各ノードでWFGを作成する
1. 各ノードのWFGをCoordinatorに集める
1. 集めたWFGを合体させる（つなぎ合わせる）
1. 合体したWFGに循環があるかどうかを確認する

今回は全ての外部サーバがPostgreSQLであることを前提とし、また、dblinkは使わない & **全部ローカルノードへの操作のみで分散デッドロックを検知する** こと目標とします。

LTでの触れたように実施にやってみて特に辛かったのは以下の２点です。

* 外部サーバに任意の関数を実行できない
* ローカルPostgesのサーバプロセスとそれが繋いでいる外部Postgresのサーバプロセスの対応付けができない

## 外部サーバに任意の関数を実行できない
前述の通り、あるPostgresサーバ上でのWFGを取得するには、pg_blocking_pids()関数を使えば簡単にできます。そのため、各サーバでpg_blocking_pids()を実行してその結果を取ってくる、ということをしたかったのですが、単純にはできませんでした。

postgres_fdwは関数をpush-downする機能を備えているのですが、push-downされるのはWHERE句内の関数のみです。そのため、`SELECT pg_blocking_pids() ,,, FROM ft ...`としても、pg_blocking_pids()は外部サーバでは実行されません[1]。

なので今回は、pg_blocking_pids()関数相当の処理をSQLでやることにしました。使ったSQLは、[let's postgres]()に載っているものを使いました。

```sql

```

## ローカルPostgesのサーバプロセスとそれが繋いでいる外部Postgresのサーバプロセスの対応付けができない

# lock_timeoutを使おう
